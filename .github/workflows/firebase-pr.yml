name: Firebase App Distribution (PR Preview)

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]

permissions:
  contents: read
  pull-requests: write
  id-token: write  # Required for Workload Identity Federation

jobs:
  # ãƒ©ãƒ™ãƒ«ãƒã‚§ãƒƒã‚¯: 'firebase-preview'ãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
  check-label:
    name: Check for firebase-preview label
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.result }}
    steps:
      - name: Check label
        id: check
        run: |
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'firebase-preview') }}" == "true" ]]; then
            echo "result=true" >> "$GITHUB_OUTPUT"
            echo "âœ… firebase-preview label found - will deploy to Firebase"
          else
            echo "result=false" >> "$GITHUB_OUTPUT"
            echo "â„¹ï¸ firebase-preview label not found - skipping Firebase deployment"
          fi

  # ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–ï¼ˆmacOSï¼‰
  build:
    name: Build Ad Hoc IPA
    needs: check-label
    if: needs.check-label.outputs.should-deploy == 'true'
    runs-on: macos-26
    outputs:
      build-number: ${{ steps.build_info.outputs.BUILD_NUMBER }}
      version-string: ${{ steps.build_info.outputs.VERSION_STRING }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.0.1.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Install Apple Certificate and Provisioning Profile (Ad Hoc)
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_ADHOC_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_ADHOC_CERTIFICATE_PASSWORD }}
          PROVISION_PROFILE_BASE64: ${{ secrets.APPLE_ADHOC_PROVISION_PROFILE_BASE64 }}
        run: |
          # Validate required secrets
          if [ -z "$CERTIFICATE_BASE64" ]; then
            echo "âŒ Error: APPLE_ADHOC_CERTIFICATE_BASE64 secret is not set"
            echo "Please configure the following GitHub Secrets:"
            echo "  - APPLE_ADHOC_CERTIFICATE_BASE64"
            echo "  - APPLE_ADHOC_CERTIFICATE_PASSWORD"
            echo "  - APPLE_ADHOC_PROVISION_PROFILE_BASE64"
            echo ""
            echo "See documentation/cicd-setup.md for setup instructions"
            exit 1
          fi

          if [ -z "$CERTIFICATE_PASSWORD" ]; then
            echo "âŒ Error: APPLE_ADHOC_CERTIFICATE_PASSWORD secret is not set"
            exit 1
          fi

          if [ -z "$PROVISION_PROFILE_BASE64" ]; then
            echo "âŒ Error: APPLE_ADHOC_PROVISION_PROFILE_BASE64 secret is not set"
            exit 1
          fi

          # Create temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERTIFICATE_PATH="$RUNNER_TEMP/certificate.p12"
          echo -n "$CERTIFICATE_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"
          security import "$CERTIFICATE_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH" "$(security list-keychains -d user | sed s/\"//g)"

          # Install provisioning profile
          PROVISION_PATH="$RUNNER_TEMP/profile.mobileprovision"
          echo -n "$PROVISION_PROFILE_BASE64" | base64 --decode -o "$PROVISION_PATH"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PROVISION_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/

          # Show installed profiles
          echo "Installed provisioning profiles:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Set build number and version
        id: build_info
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          BUILD_NUMBER=$((2000000 + PR_NUMBER))

          # Get marketing version
          MARKETING_VERSION=$(agvtool what-marketing-version -terse1)
          VERSION_STRING="${MARKETING_VERSION}-pr.${PR_NUMBER}"

          echo "BUILD_NUMBER=$BUILD_NUMBER" >> "$GITHUB_OUTPUT"
          echo "VERSION_STRING=$VERSION_STRING" >> "$GITHUB_OUTPUT"

          echo "Build number: $BUILD_NUMBER"
          echo "Version string: $VERSION_STRING"

          # Update build number
          agvtool new-version -all "$BUILD_NUMBER"

      - name: Build and Archive (Ad Hoc)
        env:
          DEVELOPMENT_TEAM: JU42S5KYL6
        run: |
          xcodebuild archive \
            -project Repeto.xcodeproj \
            -scheme Repeto \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/Repeto.xcarchive" \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
            PROVISIONING_PROFILE_SPECIFIER="Repeto Ad Hoc" \
            CODE_SIGN_IDENTITY="Apple Distribution"

      - name: Export IPA (Ad Hoc)
        run: |
          # Create ExportOptions.plist
          cat > "$RUNNER_TEMP/ExportOptions.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>teamID</key>
            <string>JU42S5KYL6</string>
            <key>uploadBitcode</key>
            <false/>
            <key>compileBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>org.kkohtaka.Repeto</key>
              <string>Repeto Ad Hoc</string>
            </dict>
          </dict>
          </plist>
          EOF

          # Export archive to IPA
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/Repeto.xcarchive" \
            -exportPath "$RUNNER_TEMP/export" \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist"

          echo "âœ… IPA exported successfully"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: Repeto-PR${{ github.event.pull_request.number }}.ipa
          path: ${{ runner.temp }}/export/Repeto.ipa
          retention-days: 7

      - name: Clean up keychain
        if: always()
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH"
          fi

  # é…å¸ƒã‚¸ãƒ§ãƒ–ï¼ˆLinux - ã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
  distribute:
    name: Distribute to Firebase
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for WIF
      pull-requests: write
    steps:
      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: Repeto-PR${{ github.event.pull_request.number }}.ipa

      # Authenticate to Google Cloud using Workload Identity Federation
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # Setup Node.js for Firebase CLI
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install Firebase CLI
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # Upload to Firebase App Distribution using CLI
      - name: Upload to Firebase App Distribution
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_BODY: ${{ github.event.pull_request.body }}
          BUILD_NUMBER: ${{ needs.build.outputs.build-number }}
          VERSION_STRING: ${{ needs.build.outputs.version-string }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
        run: |
          # Create release notes file
          cat > release-notes.txt <<EOF
          ðŸš€ PR Preview Build

          **PR #${PR_NUMBER}**: ${PR_TITLE}

          **Author**: @${PR_AUTHOR}
          **Branch**: \`${PR_BRANCH}\`
          **Build**: ${BUILD_NUMBER}
          **Version**: ${VERSION_STRING}

          ---

          ${PR_BODY}
          EOF

          # Upload IPA
          firebase appdistribution:distribute Repeto.ipa \
            --app "${FIREBASE_APP_ID}" \
            --groups "internal-testers" \
            --release-notes-file release-notes.txt

      - name: Comment PR with distribution info
        uses: actions/github-script@v7
        with:
          script: |
            const buildNumber = '${{ needs.build.outputs.build-number }}';
            const versionString = '${{ needs.build.outputs.version-string }}';
            const prNumber = context.issue.number;

            const body = `## ðŸš€ Firebase App Distribution Upload Complete!

            **Build Information:**
            - Build Number: \`${buildNumber}\`
            - Version: \`${versionString}\`
            - PR: #${prNumber}

            **For Testers:**
            1. Check your email for the Firebase invitation
            2. If using iOS 16+, enable Developer Mode on your device
            3. Download the app using the link in the email

            **Firebase Console:**
            [View Distribution Status](https://console.firebase.google.com/project/_/appdistribution)

            ---

            â„¹ï¸ This build is signed with an **Ad Hoc** provisioning profile and will only work on registered devices.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: Distribution summary
        run: |
          echo "âœ… Successfully distributed to Firebase App Distribution!"
          echo "Build number: ${{ needs.build.outputs.build-number }}"
          echo "Version: ${{ needs.build.outputs.version-string }}"
          echo "PR: #${{ github.event.pull_request.number }}"
