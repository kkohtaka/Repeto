name: Firebase App Distribution (PR Preview)

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]

permissions:
  contents: read
  pull-requests: write

jobs:
  # „É©„Éô„É´„ÉÅ„Çß„ÉÉ„ÇØ: 'firebase-preview'„É©„Éô„É´„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂÆüË°å
  check-label:
    name: Check for firebase-preview label
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.result }}
    steps:
      - name: Check label
        id: check
        run: |
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'firebase-preview') }}" == "true" ]]; then
            echo "result=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ firebase-preview label found - will deploy to Firebase"
          else
            echo "result=false" >> "$GITHUB_OUTPUT"
            echo "‚ÑπÔ∏è firebase-preview label not found - skipping Firebase deployment"
          fi

  # „Éì„É´„Éâ„Ç∏„Éß„ÉñÔºàmacOSÔºâ
  build:
    name: Build Ad Hoc IPA
    needs: check-label
    if: needs.check-label.outputs.should-deploy == 'true'
    runs-on: macos-26
    outputs:
      build-number: ${{ steps.build_info.outputs.BUILD_NUMBER }}
      version-string: ${{ steps.build_info.outputs.VERSION_STRING }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.0.1.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Install Apple Certificate and Provisioning Profile (Ad Hoc)
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_ADHOC_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_ADHOC_CERTIFICATE_PASSWORD }}
          PROVISION_PROFILE_BASE64: ${{ secrets.APPLE_ADHOC_PROVISION_PROFILE_BASE64 }}
        run: |
          # Validate required secrets
          if [ -z "$CERTIFICATE_BASE64" ]; then
            echo "‚ùå Error: APPLE_ADHOC_CERTIFICATE_BASE64 secret is not set"
            echo "Please configure the following GitHub Secrets:"
            echo "  - APPLE_ADHOC_CERTIFICATE_BASE64"
            echo "  - APPLE_ADHOC_CERTIFICATE_PASSWORD"
            echo "  - APPLE_ADHOC_PROVISION_PROFILE_BASE64"
            echo ""
            echo "See documentation/cicd-setup.md for setup instructions"
            exit 1
          fi

          if [ -z "$CERTIFICATE_PASSWORD" ]; then
            echo "‚ùå Error: APPLE_ADHOC_CERTIFICATE_PASSWORD secret is not set"
            exit 1
          fi

          if [ -z "$PROVISION_PROFILE_BASE64" ]; then
            echo "‚ùå Error: APPLE_ADHOC_PROVISION_PROFILE_BASE64 secret is not set"
            exit 1
          fi

          # Create temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERTIFICATE_PATH="$RUNNER_TEMP/certificate.p12"
          echo -n "$CERTIFICATE_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"
          security import "$CERTIFICATE_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH" "$(security list-keychains -d user | sed s/\"//g)"

          # Install provisioning profile
          PROVISION_PATH="$RUNNER_TEMP/profile.mobileprovision"
          echo -n "$PROVISION_PROFILE_BASE64" | base64 --decode -o "$PROVISION_PATH"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PROVISION_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/

          # Show installed profiles
          echo "Installed provisioning profiles:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Set build number and version
        id: build_info
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          BUILD_NUMBER=$((2000000 + PR_NUMBER))

          # Get marketing version
          MARKETING_VERSION=$(agvtool what-marketing-version -terse1)
          VERSION_STRING="${MARKETING_VERSION}-pr.${PR_NUMBER}"

          echo "BUILD_NUMBER=$BUILD_NUMBER" >> "$GITHUB_OUTPUT"
          echo "VERSION_STRING=$VERSION_STRING" >> "$GITHUB_OUTPUT"

          echo "Build number: $BUILD_NUMBER"
          echo "Version string: $VERSION_STRING"

          # Update build number
          agvtool new-version -all "$BUILD_NUMBER"

      - name: Build and Archive (Ad Hoc)
        env:
          DEVELOPMENT_TEAM: JU42S5KYL6
        run: |
          xcodebuild archive \
            -project Repeto.xcodeproj \
            -scheme Repeto \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/Repeto.xcarchive" \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
            PROVISIONING_PROFILE_SPECIFIER="Repeto Ad Hoc" \
            CODE_SIGN_IDENTITY="Apple Distribution"

      - name: Export IPA (Ad Hoc)
        run: |
          # Create ExportOptions.plist
          cat > "$RUNNER_TEMP/ExportOptions.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>teamID</key>
            <string>JU42S5KYL6</string>
            <key>uploadBitcode</key>
            <false/>
            <key>compileBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>org.kkohtaka.Repeto</key>
              <string>Repeto Ad Hoc</string>
            </dict>
          </dict>
          </plist>
          EOF

          # Export archive to IPA
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/Repeto.xcarchive" \
            -exportPath "$RUNNER_TEMP/export" \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist"

          echo "‚úÖ IPA exported successfully"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: Repeto-PR${{ github.event.pull_request.number }}.ipa
          path: ${{ runner.temp }}/export/Repeto.ipa
          retention-days: 7

      - name: Clean up keychain
        if: always()
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH"
          fi

  # ÈÖçÂ∏É„Ç∏„Éß„ÉñÔºàLinux - „Ç≥„Çπ„ÉàÂâäÊ∏õÔºâ
  distribute:
    name: Distribute to Firebase
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: Repeto-PR${{ github.event.pull_request.number }}.ipa

      - name: Upload to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          file: Repeto.ipa
          groups: internal-testers
          releaseNotes: |
            üöÄ PR Preview Build

            **PR #${{ github.event.pull_request.number }}**: ${{ github.event.pull_request.title }}

            **Author**: @${{ github.event.pull_request.user.login }}
            **Branch**: `${{ github.event.pull_request.head.ref }}`
            **Build**: ${{ needs.build.outputs.build-number }}
            **Version**: ${{ needs.build.outputs.version-string }}

            ---

            ${{ github.event.pull_request.body }}

      - name: Comment PR with distribution info
        uses: actions/github-script@v7
        with:
          script: |
            const buildNumber = '${{ needs.build.outputs.build-number }}';
            const versionString = '${{ needs.build.outputs.version-string }}';
            const prNumber = context.issue.number;

            const body = `## üöÄ Firebase App Distribution Upload Complete!

            **Build Information:**
            - Build Number: \`${buildNumber}\`
            - Version: \`${versionString}\`
            - PR: #${prNumber}

            **For Testers:**
            1. Check your email for the Firebase invitation
            2. If using iOS 16+, enable Developer Mode on your device
            3. Download the app using the link in the email

            **Firebase Console:**
            [View Distribution Status](https://console.firebase.google.com/project/_/appdistribution)

            ---

            ‚ÑπÔ∏è This build is signed with an **Ad Hoc** provisioning profile and will only work on registered devices.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: Distribution summary
        run: |
          echo "‚úÖ Successfully distributed to Firebase App Distribution!"
          echo "Build number: ${{ needs.build.outputs.build-number }}"
          echo "Version: ${{ needs.build.outputs.version-string }}"
          echo "PR: #${{ github.event.pull_request.number }}"
