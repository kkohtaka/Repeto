# Repeto - デザインドキュメント

## システムアーキテクチャ

### アーキテクチャパターン: MVVM

- **View**: SwiftUIで実装されたUI層
- **ViewModel**: ViewとModelの橋渡し、状態管理
- **Model**: Core Dataエンティティ、ビジネスロジック
- **Service**: データ管理と通知サービス

### ディレクトリ構造

```
ios/Repeto/
├── App/
│   └── RepetoApp.swift              # アプリエントリーポイント
│
├── Models/
│   ├── Task.swift                   # タスクモデル
│   └── CoreData/
│       ├── Repeto.xcdatamodeld      # Core Dataスキーマ
│       └── PersistenceController.swift
│
├── Views/
│   ├── TaskListView.swift           # タスク一覧画面
│   └── TaskFormView.swift           # タスク作成/編集画面
│
├── ViewModels/
│   ├── TaskListViewModel.swift      # タスク一覧VM
│   └── TaskFormViewModel.swift      # タスクフォームVM
│
├── Services/
│   ├── TaskService.swift            # タスク管理サービス
│   └── NotificationService.swift    # 通知管理サービス
│
└── Resources/
    └── Assets.xcassets              # 画像アセット
```

---

## データモデル設計

### Task エンティティ

| 属性名 | 型 | 必須 | 説明 |
|-------|-----|------|------|
| id | UUID | ✓ | 一意識別子 |
| title | String | ✓ | タスク名 |
| intervalValue | Int32 | ✓ | インターバル値（例: 3） |
| intervalUnit | String | ✓ | インターバル単位（"day", "week", "month"） |
| lastCompletedDate | Date | | 最終完了日時 |
| nextReminderDate | Date | ✓ | 次回リマインド日時 |
| createdDate | Date | ✓ | 作成日時 |
| isActive | Bool | ✓ | アクティブ状態 |
| notificationEnabled | Bool | ✓ | 通知有効/無効 |

**インデックス**:
- nextReminderDate（ソート用）

**CloudKit対応**:
- Core DataとCloudKitの自動同期を使用
- NSPersistentCloudKitContainerを利用

### インターバル単位

- **day**: 日ごと
- **week**: 週ごと
- **month**: 月ごと

---

## UI/UX設計

### デザイン原則

1. **シンプル第一**: 必要最小限のUI要素で直感的な操作
2. **視認性**: 次回リマインド日を明確に表示
3. **効率性**: タスク完了まで最短ステップ
4. **一貫性**: iOS Human Interface Guidelinesに準拠

### 状態表示

- **期限切れ**: 赤色で強調表示
- **今日**: オレンジ色で表示
- **今後**: 通常表示

---

## 画面設計

### 1. タスク一覧画面

**主な機能**:
- タスク一覧表示（次回リマインド日でソート）
- セクション別表示（期限切れ、今日、今後）
- タスク追加ボタン
- タスクタップで完了マーク → 次回リマインド自動設定
- スワイプで削除・編集

**表示内容（各タスク行）**:
- タスク名
- 次回リマインド日時
- インターバル表示（例: 3日ごと）

### 2. タスク作成/編集画面

**入力項目**:
- タスク名（必須）
- インターバル設定（必須）
  - 数値入力
  - 単位選択（日/週/月）
- 次回リマインド日時（必須）
- 通知の有効/無効

**バリデーション**:
- タスク名: 1文字以上
- インターバル: 1以上の整数
- 次回リマインド日: 現在以降の日時

---

## 通知システム

### 通知のタイミング

- タスク作成時: 次回リマインド日に通知をスケジュール
- タスク完了時: 新しい次回リマインド日に通知を再スケジュール
- タスク編集時: 通知を更新
- タスク削除時: 通知をキャンセル

### 通知の内容

```
タイトル: "タスクのリマインダー"
本文: "「[タスク名]」の時間です"
```

### 通知数の制限

**iOSの制限**:
- ローカル通知は最大64個までしかスケジュールできない

**対応策**:
- 次回リマインド日が近い順に64個まで通知をスケジュール
- アプリ起動時・タスク完了時に通知を再評価・再スケジュール
- 65個目以降のタスクもデータ上は管理され、上位64個に入った時点で通知追加
- ユーザーには制限を意識させない設計

---

## iCloud同期

### 同期方式

**NSPersistentCloudKitContainer**を使用した自動同期：
- Core Dataの変更を自動的にCloudKitに同期
- 複数デバイス間でリアルタイム同期
- コンフリクト解決は自動処理

### 必要な設定

1. **iCloud Capability**
   - iCloud Documents
   - CloudKit

2. **CloudKit Container**
   - デフォルトコンテナを使用
   - プライベートデータベースに保存

3. **Entitlements**
   - iCloud Key-Value Storage
   - CloudKit

### 同期の動作

- **作成**: 新規タスクは自動的にiCloudに同期
- **更新**: タスクの変更は即座に同期
- **削除**: 削除操作もすべてのデバイスに反映
- **競合**: 最終更新時刻ベースで自動解決

### オフライン対応

- ネットワーク未接続時はローカルに保存
- 接続回復時に自動的に同期
- ユーザーは同期状態を意識せず使用可能

---

## コアロジック

### インターバル計算

タスク完了時、現在時刻からインターバル分を加算して次回リマインド日を計算：

- 日ごと: 現在時刻 + X日
- 週ごと: 現在時刻 + X週
- 月ごと: 現在時刻 + Xヶ月

### タスク完了処理

1. 最終完了日時を現在時刻に更新
2. 次回リマインド日を計算して更新
3. 新しい日時で通知を再スケジュール
4. データを保存

---

## プライバシーとセキュリティ

### データ保存

- データはiCloud（プライベートデータベース）に保存
- ユーザーのiCloudアカウントに紐付けて管理
- エンドツーエンド暗号化
- 開発者はユーザーデータにアクセス不可

### iCloudアカウント

- iCloudへのサインインが必須
- サインインしていない場合は通知を表示
- ローカルのみの動作モードは提供しない

### 通知権限

- 初回起動時に通知権限をリクエスト
- 権限が拒否された場合もアプリは動作（通知なし）

